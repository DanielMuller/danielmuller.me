+++
title = "Koken: Serve assets through CDN"
author = "Daniel"
date = "2014-11-22T08:05:53+00:00"
slug = "koken-serve-assets-through-cdn"
image = "/images/2014/11/koken-logo.png"
categories = [
  "Koken",
  "Photos"
]
tags = [
  "CDN",
  "Gallery",
  "Speed"
]
[amp]
elements = ["amp-social-share"]
+++
You can highly improve your site display speed by using a [CDN](http://en.wikipedia.org/wiki/Content_delivery_network). This is also true with [Koken](http://koken.me).

Koken doesn't provide a "out of the box" way to handle CDN, so I wrote a [plugin](https://github.com/DanielMuller/koken-plugin-cdn) to allow you to serve your Koken assets through edges closer to your visitors.

<!--more-->

## CDN? Isn't that overkill?

You could think that way. Specially when you have an [album](http://daniel.mesphotos.ch) like mine, which is more family and friends oriented with a really low traffic footprint. The Problem is that family and friends are spread across the world: South America, Europe, South-East Asia. By choosing your server location, you can only make a nice user experience to one region. Using a CDN will allow to give an equal experience to all of them.

## Why not "All CDN" ?

A more easy way would have been to go the all CDN, by pointing your domain to your CDN provider and using you Koken installation as backend. This thought crossed my mind, but I ruled it out quickly, I didn't want to enter the fine-tuning game of html and admin caching.

## Koken CDN plugin

This [plugin](https://github.com/DanielMuller/koken-plugin-cdn) is a set of filters rewriting the output of Koken's API (_api.content_) and the html output (_site.output_). API rewrite is used to rewrite the URL's of the images and HTML rewrite is used to rewrite URL's of stylesheets, javascripts and fonts. The plugin let you choose which assets you want behind a CDN.

## Prepare your site for a CDN

  * The best practice to manage caching rules on the CDN is to define the right cache headers on your Koken installation. Koken is missing some cache headers as pointed out in my other article: "[Boost your Koken speed with client-side caching](/2014/11/boost-your-koken-speed-with-client-side-caching/)". First step is to fix this issues. up to you to choose the right amount of cache expiry. This depends on your traffic and on time for a visitor to return.
  * A second issue from Koken, is that the images a generated by a [PHP](http://www.php.net) script (_i.php_), which uses `$_SERVER['HTTP_HOST']` to call the API. To avoid a full loop back through the CDN, your CDN provider needs to be able to call your website using the backend Host header.
  * Choose a CDN provider, define _cdn.yoursite.com_ as endpoint using _yoursite.com_ as backend. Update your DNS and create the entry _cdn.yoursite.com_ pointing to your CDN provider.
  * Install the plugin, configure it to use _cdn.yoursite.com_
  * Enjoy your new speed

## Which CDN to use ?

There are so many out there, difficult to point towards one. All depends on your expectations and budget. This [article](http://www.wpexplorer.com/free-cdn-services-for-wordpress/) holds a list of free CDN, which can be a good starting point to experiment without opening the wallet.

After looking a bit around, my choices where:

  * [Cloudflare](http://cloudflare.net): I used to use them for this site, but you need to host your DNS with them and top level domain only. I couldn't use them with my album, since I don't use top-level domain.
  * [Incapsula](http://www.incapsula.com/): They have a free plan, but the link to it is well hidden below the paid ones. I didn't give them a try
  * [Cloudfront](http://aws.amazon.com/cloudfront/): Not free, but cheap enough compared to the service offered. I already have an account for my S3-backups and I am familiar with the configuration. I went CF, since I had some vouchers to spend.

## What are the gains?

My server is located in Europe, I access the Gallery from South-East Asia and the differences are phenomenal.

Load times for one image:

  * Without CDN: 3100 ms
  * With CDN: 60 ms

Your visitor will get the image almost instantly where before he had to wait 3s to see it appear on his screen.
